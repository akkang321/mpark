<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.zenith.admin.situation.dao.AdminSituationDao">


	<select id="situationClassList" resultType="hashmap">
		<include refid="common.stratPage" />
		SELECT 	S_ID		,TEACHER_NAME		,CLASS_NAME		,SCHEDULE_DATE		,START_TIME		,END_TIME		,CNT		,REAL_CNT 

		FROM 
		(SELECT 	S.S_ID				,T.TEACHER_NAME		,C.CLASS_NAME				,S.SCHEDULE_DATE 
				,S.START_TIME		,S.END_TIME 		,COUNT(R.R_ID) AS CNT 		,COUNT(R1.R_ID)		AS	REAL_CNT 
		FROM 	CLASS_INFO C 

		INNER 	JOIN TEACHER_INFO T ON C.T_ID = T.T_ID
		INNER 	JOIN SCHEDULE_INFO S ON C.C_ID = S.C_ID 
		LEFT 	JOIN RESERVATION_INFO R ON R.S_ID = S.S_ID 
		LEFT 	JOIN RESERVATION_INFO R1 ON R.R_ID = R1.R_ID 
		AND 	R1.JOIN_STATE = 'C110100'
		GROUP 	BY 		S.S_ID
		ORDER 	BY 		S.SCHEDULE_DATE ASC, S.START_TIME ASC) newTable 
		
		<where>
			<if test="sClassName != null and sClassName != ''">
				AND CLASS_NAME LIKE CONCAT('%',#{sClassName},'%') 
			</if>
			<if test="sTeacherName != null and sTeacherName != ''">
				AND TEACHER_NAME LIKE CONCAT('%',#{sTeacherName},'%') 
			</if>
		</where>
		
		<include refid="common.endPage" /> 
	</select>


	<select id="situationClassCnt" parameterType="hashmap" resultType="int"> 
		SELECT 	count(1) AS CNT
		FROM 

		(SELECT		S.S_ID				,T.TEACHER_NAME		,C.CLASS_NAME				,S.SCHEDULE_DATE
					,S.START_TIME		,S.END_TIME 		,COUNT(R.R_ID) AS CNT 		,COUNT(R1.R_ID)		AS	REAL_CNT
		FROM 		CLASS_INFO C 

		INNER 	JOIN TEACHER_INFO T ON C.T_ID = T.T_ID
		INNER 	JOIN SCHEDULE_INFO S ON C.C_ID = S.C_ID 
		LEFT 	JOIN RESERVATION_INFO R ON R.S_ID = S.S_ID 
		LEFT 	JOIN RESERVATION_INFO R1 ON R.R_ID = R1.R_ID	AND 	R1.JOIN_STATE = 'C110100'
		
		GROUP 	BY S.S_ID
		ORDER 	BY S.SCHEDULE_DATE ASC, S.START_TIME ASC) newTable
	</select>

	
	<select id="situationClassInfo" parameterType="hashmap" resultType="hashmap">
		SELECT		S.S_ID, R.R_ID		,C.CLASS_NAME		,T.TEACHER_NAME		
					,S.SCHEDULE_DATE	,S.START_TIME		,S.END_TIME
					,U.U_ID				,U.USER_NAME		,U.PHONE	,U.EMAIL
					,CASE WHEN R.JOIN_STATE='C110100' THEN '참석' ELSE '미참석' END AS JOIN_STATE
		
		FROM 				CLASS_INFO 			C
			INNER 	JOIN 	TEACHER_INFO 		T 	ON T.T_ID = C.T_ID
			INNER 	JOIN 	SCHEDULE_INFO 		S 	ON S.C_ID = C.C_ID
			LEFT 	JOIN 	RESERVATION_INFO 	R 	ON R.S_ID = S.S_ID
			INNER 	JOIN 	USER_INFO 			U 	ON U.U_ID = R.U_ID 

		WHERE S.S_ID = #{sId}
		ORDER BY SCHEDULE_DATE ASC, START_TIME ASC
	</select>


	<select id="sClassInfo" parameterType="hashmap" resultType="hashmap">
		SELECT 		S.SCHEDULE_DATE		,S.START_TIME		,S.END_TIME		,T.TEACHER_NAME		,C.CLASS_NAME 
		FROM 		SCHEDULE_INFO S

		INNER JOIN CLASS_INFO C ON C.C_ID=S.C_ID
		INNER JOIN TEACHER_INFO T ON T.T_ID=C.T_ID

		WHERE S.S_ID = #{sId}
		LIMIT 1
	</select>


</mapper>


