<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zenith.user.mypage.dao.UserClassDao">


	<select id="userClassList" parameterType="hashmap" resultType="hashmap"> 
	<include refid="common.stratPage" /> 
    	SELECT 		U.U_ID		,T.T_ID		,C.C_ID		,S.S_ID				,C.CLASS_NAME			,U.USER_NAME			,T.TEACHER_NAME			,S.SCHEDULE_DATE		
					,TIME_FORMAT(S.START_TIME, '%H:%i') AS START_TIME		,TIME_FORMAT(S.END_TIME, '%H:%i') AS END_TIME
					,FN_CODE_NAME(C.CLASS_ROOM) AS CLASS_ROOM		,FN_CODE_NAME(R.RESERVATION_TYPE) AS FN_RESERVATION_TYPE		
					,R.RESERVATION_TYPE		,DATE_FORMAT(R.CREATE_DATE, '%Y-%m-%d %H:%i') AS CREATE_DATE	,R.R_ID
					,C.CLASS_TYPE
		FROM 		CLASS_INFO				C
			INNER 	JOIN TEACHER_INFO 		T ON T.T_ID=C.T_ID 
			INNER 	JOIN SCHEDULE_INFO 		S ON S.C_ID=C.C_ID 
			INNER 	JOIN RESERVATION_INFO 	R ON R.S_ID=S.S_ID
			INNER 	JOIN USER_INFO 			U ON U.U_ID=R.U_ID
		
		WHERE U.U_ID=#{uId}
		ORDER BY R.R_ID DESC
	<include refid="common.endPage"/> 
	</select> 


	<select id="userClassCnt" parameterType="hashmap" resultType="int"> 
		SELECT 		COUNT(1)

		FROM 		CLASS_INFO				C
			LEFT 	JOIN TEACHER_INFO 		T ON T.T_ID=C.T_ID 
			LEFT 	JOIN SCHEDULE_INFO 		S ON S.C_ID=C.C_ID 
			RIGHT 	JOIN RESERVATION_INFO 	R ON R.S_ID=S.S_ID
			LEFT 	JOIN USER_INFO 			U ON U.U_ID=R.U_ID

		WHERE U.U_ID=#{ uId }
	</select> 
	
	
	<update id="reservationCancel" parameterType="hashmap"> 
		UPDATE	RESERVATION_INFO 
		SET 	RESERVATION_TYPE="C080200" 
		WHERE 	U_ID=#{ uId } 
		AND		R_ID=#{ rId } 
	</update>
	
	<update id="ticketCntUpdate" parameterType="hashmap"> 
		UPDATE	TICKET_INFO
		SET 	NOW_TICKET_CNT = (NOW_TICKET_CNT+1)
				,USE_TICKET_CNT = (USE_TICKET_CNT-1)
				,USE_STATE = 'C130100'
		WHERE 	T_ID = #{tId}
	</update>
	
	<select id="scheduleInfo" parameterType="hashmap" resultType="hashmap"> 
		SELECT 	S.S_ID	,DATE_FORMAT(S.SCHEDULE_DATE,'%Y년%m월%d일') AS SCHEDULE_DATE
				,CONVERT(DATE_FORMAT(S.SCHEDULE_DATE,'%d'),signed) AS DAY
				,DATE_FORMAT(S.START_TIME,'%H:%i') AS START_TIME
				,DATE_FORMAT(S.END_TIME,'%H:%i') AS END_TIME
				,FN_TEACHER_NAME(C.T_ID) AS FN_TEACHER_NAME
				,C.CLASS_NAME	
				,FN_CODE_NAME(C.CLASS_LEVEL) AS CLASS_LEVEL
				,FN_CODE_NAME(C.CLASS_ROOM) AS CLASS_ROOM
				,R.R_ID	,R.T_ID
		FROM 	SCHEDULE_INFO S INNER JOIN CLASS_INFO C ON S.C_ID = C.C_ID
				INNER JOIN RESERVATION_INFO R ON R.S_ID = S.S_ID
		WHERE  	R.R_ID = #{rId} 
	</select>
	
	
	
</mapper>


