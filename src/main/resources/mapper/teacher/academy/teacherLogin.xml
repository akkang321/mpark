<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zenith.teacher.login.dao.TeacherLoginDao">


<select id="teacherLoginClassList" parameterType="hashmap" resultType="hashmap">

	SELECT		A.CLASS_NAME		,IFNULL(A.SCHEDULE_TOL, 0) AS SCHEDULE_TOL		,IFNULL(SCHEDULE_ON_CNT, 0) AS SCHEDULE_ON_CNT		
				,A.USER_CNT			,A.CLASS_STATE									,A.T_ID, A.C_ID
	FROM 
		(
		SELECT		COUNT(S.S_ID) AS SCHEDULE_TOL		,T.T_ID				,C.C_ID		
					,C.CLASS_NAME						,C.USER_CNT			,FN_CODE_NAME(C.CLASS_STATE) AS CLASS_STATE
		FROM 		CLASS_INFO C
			LEFT 	JOIN TEACHER_INFO 	T ON T.T_ID=C.T_ID
			RIGHT 	JOIN SCHEDULE_INFO 	S ON S.C_ID=C.C_ID
		GROUP BY 	C.C_ID, T.T_ID
		ORDER BY 	T.T_ID ASC
		) A

		LEFT JOIN

			(
			SELECT		C_ID		,T_ID		,COUNT(S_ID) AS SCHEDULE_ON_CNT 
			FROM 
			(
			(
			SELECT		C.CLASS_NAME		,C.USER_CNT		,FN_CODE_NAME(C.CLASS_STATE) AS CLASS_STATE,
						S.S_ID				,T.T_ID			,C.C_ID
			FROM 		CLASS_INFO C
				LEFT 	JOIN TEACHER_INFO 	T ON T.T_ID=C.T_ID
				RIGHT 	JOIN SCHEDULE_INFO 	S ON S.C_ID=C.C_ID
			
			WHERE 	S.SCHEDULE_DATE = CURDATE()
			AND 	START_TIME >= CURTIME()
			)

	UNION 

			(
			SELECT 		C.CLASS_NAME		,C.USER_CNT		,FN_CODE_NAME(C.CLASS_STATE) 
						,S.S_ID				,T.T_ID			,C.C_ID 
			FROM 		CLASS_INFO C 
				LEFT 	JOIN TEACHER_INFO 	T ON T.T_ID=C.T_ID
				RIGHT 	JOIN SCHEDULE_INFO 	S ON S.C_ID=C.C_ID

			WHERE S.SCHEDULE_DATE > CURDATE()
			)
			) N
			GROUP BY T_ID	,C_ID
			ORDER BY T_ID 	ASC
			) B 			ON 		B.T_ID=A.T_ID AND B.C_ID=A.C_ID

<if test="tId!=null and tId!=''">
	WHERE A.T_ID=#{ tId }
</if>

ORDER BY A.T_ID, A.C_ID

</select>


<select id="teacherInfo" resultType="hashmap" parameterType="hashmap">
	SELECT 		T_ID				,TEACHER_NAME		,PHONE		,EMAIL		,PHOTO_ID		,VIDEO_URL		
				,TEACHER_STATE		,TEACHER_NAME_EN	,TEACHER_CONTENTS		,TEACHER_INTRODUCTION		,SELF_INTRODUCTION
	FROM 		TEACHER_INFO

	WHERE 		T_ID=#{ tId }
	AND 		TEACHER_PW=#{ userPw }
</select>


<update id="updateLogin" parameterType="hashmap">
	UPDATE 		TEACHER_INFO SET UPDATE_DATE=NOW()
	WHERE 		T_ID=#{ tId }
</update>


</mapper>

